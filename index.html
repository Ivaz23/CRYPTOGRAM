<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞–º–º–∞: –ó–∏–º–Ω–∏–µ –¢–∞–π–Ω—ã</title>
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <style>
        :root {
            --bg-color: #d6e4f0;
            --card: rgba(255, 255, 255, 0.98);
            --primary: #c0392b; 
            --correct: #27ae60;
            --error: #e74c3c;
            --text: #2c3e50;
            --border: #d1d5db;
            --hint: #2980b9;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            outline: none;
        }

        html, body {
            margin: 0; padding: 0; 
            width: 100%; height: 100%;
            overflow: hidden; 
            background-color: var(--bg-color);
            overscroll-behavior: none;
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; 
            flex-direction: column;
            background-image: radial-gradient(circle at center, #e1eef6 0%, #d6e4f0 100%);
        }

        #snow-container { position: fixed; inset: 0; pointer-events: none; z-index: 100; overflow: hidden; }
        .snowflake { position: absolute; top: -10px; color: white; opacity: 0.8; user-select: none; pointer-events: none; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

        header {
            height: 50px; background: #fff;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100; flex-shrink: 0;
        }
        .stats { display: flex; gap: 15px; font-weight: 800; font-size: 0.9rem; }
        .lives { color: var(--primary); }

        main {
            flex: 1; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            padding: 20px 10px;
            -webkit-overflow-scrolling: touch;
        }

        #puzzle-container {
            display: flex; flex-wrap: wrap; justify-content: center;
            align-content: flex-start; gap: 6px; width: 100%; max-width: 800px; margin: 0 auto;
        }

        .word { display: flex; gap: 4px; margin-right: 12px; margin-bottom: 20px; }
        .author-div { border-top: 2px dashed #bdc3c7; padding-top: 15px; margin-top: 5px; width: 100%; display: flex; justify-content: center; flex-wrap: wrap; }

        .cell { 
            width: clamp(32px, 8vw, 42px); display: flex; flex-direction: column; 
            align-items: center; cursor: pointer;
        }
        .box {
            width: 100%; aspect-ratio: 1/1.1; background: var(--card);
            border: 2px solid var(--border); border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: clamp(1rem, 5vw, 1.4rem); font-weight: 900;
            color: var(--text);
        }
        .num { margin-top: 3px; font-size: 0.6rem; color: #7f8c8d; font-weight: bold; }

        .cell.sel .box { border-color: var(--primary); background: #fff; transform: scale(1.05); box-shadow: 0 0 8px rgba(192,57,43,0.2); }
        .cell.ok .box { color: var(--correct); border-color: var(--correct); background: #fafffa; }
        .cell.bad .box { animation: shake 0.3s ease-in-out; border-color: var(--error); }

        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-4px);} 75%{transform:translateX(4px);} }

        #footer {
            flex-shrink: 0; background: #f8f9fa;
            padding: 10px 5px calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1); z-index: 100;
        }

        .kbd-row { display: flex; justify-content: center; gap: 3px; margin-bottom: 4px; }
        .key {
            background: #fff; height: clamp(40px, 6vh, 50px); flex: 1; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: clamp(0.9rem, 4vw, 1.1rem);
            cursor: pointer; border: 1px solid #ddd; box-shadow: 0 2px 0 #ccc;
            max-width: 45px;
        }
        .key:active { transform: translateY(1px); box-shadow: none; }
        .key.faded { opacity: 0.3; background: #eee; }

        .hint-btn { background: var(--hint); color: #fff; border: none; padding: 12px; border-radius: 10px; font-weight: 800; cursor: pointer; width: 100%; max-width: 400px; display: block; margin: 8px auto 0; font-size: 0.8rem; }

        .ovl {
            position: fixed; inset: 0; z-index: 500; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            background: rgba(44, 62, 80, 0.95); color: white; padding: 20px; text-align: center;
        }
        .btn { background: var(--correct); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 1.2rem; font-weight: 900; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="snow-container"></div>

<div id="sc-menu" class="ovl" style="display: flex; background: linear-gradient(to bottom, #2980b9, #2c3e50);">
    <div style="font-size: 5rem;">‚ùÑÔ∏è</div>
    <h1 style="margin: 10px 0;">–ó–ò–ú–ù–ò–ï –¢–ê–ô–ù–´</h1>
    <p>–†–∞–∑–≥–∞–¥–∞–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –æ –∑–∏–º–µ –∏ –∂–∏–∑–Ω–∏</p>
    <div style="margin: 10px 0; font-size: 1.2rem; color: #f1c40f;">–†–ï–ö–û–†–î: <span id="ui-record">0</span></div>
    <button class="btn" onclick="start()">–ò–ì–†–ê–¢–¨</button>
</div>

<div id="sc-fail" class="ovl">
    <h2 style="font-size: 2rem; color: var(--error);">–ü–û–ü–´–¢–ö–ò –ó–ê–ö–û–ù–ß–ò–õ–ò–°–¨</h2>
    <p>–ù–µ —Å–¥–∞–≤–∞–π—Ç–µ—Å—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!</p>
    <button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
</div>

<div id="sc-win" class="ovl">
    <div style="font-size: 4rem;">‚ú®</div>
    <h2>–¶–ò–¢–ê–¢–ê –†–ê–ó–ì–ê–î–ê–ù–ê!</h2>
    <p id="ui-auth-name" style="color:#f1c40f; font-style: italic; font-size: 1.2rem;"></p>
    <button class="btn" onclick="nextLvl()">–°–õ–ï–î–£–Æ–©–ê–Ø</button>
</div>

<header id="h-ui" style="display:none;">
    <div class="stats">
        <span>‚≠ê <span id="s-val">0</span></span>
        <span class="lives" id="l-val">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
    </div>
    <button onclick="location.reload()" style="background:none; border:none; font-size: 1.2rem; cursor:pointer;">üè†</button>
</header>

<main id="m-ui" style="display:none;">
    <div id="puzzle-container"></div>
</main>

<div id="f-ui" style="display:none;">
    <div id="kbd"></div>
    <button class="hint-btn" onclick="showHint()">–ü–û–î–°–ö–ê–ó–ö–ê (–°–ú–û–¢–†–ï–¢–¨ –†–ï–ö–õ–ê–ú–£)</button>
</div>

<script>
    const phrases = [
        {q: "–ó–ò–ú–ê –≠–¢–û –í–†–ï–ú–Ø –î–õ–Ø –ö–û–ú–§–û–†–¢–ê –•–û–†–û–®–ï–ô –ï–î–´ –ò –¢–ï–ü–õ–ê", a: "–≠–î–ò–¢ –°–ò–¢–£–≠–õ–õ"},
        {q: "–ö–ê–ñ–î–ê–Ø –°–ù–ï–ñ–ò–ù–ö–ê –≠–¢–û –í–ó–î–û–• –û–ë–õ–ï–ì–ß–ï–ù–ò–Ø –ü–†–ò–†–û–î–´", a: "–ù–ï–ò–ó–í–ï–°–¢–ù–´–ô"},
        {q: "–õ–Æ–ë–û–í–¨ –°–û–ì–†–ï–í–ê–ï–¢ –î–ê–ñ–ï –í –°–ê–ú–´–ô –õ–Æ–¢–´–ô –ú–û–†–û–ó", a: "–ü–û–°–õ–û–í–ò–¶–ê"},
        {q: "–ó–ò–ú–ê –ü–†–ò–•–û–î–ò–¢ –ß–¢–û–ë–´ –ú–´ –¶–ï–ù–ò–õ–ò –í–ï–°–ù–£", a: "–ê–ù–¢–û–ù –ß–ï–•–û–í"},
        {q: "–°–ù–ï–ì–û–ü–ê–î –≠–¢–û –ú–£–ó–´–ö–ê –ö–û–¢–û–†–£–Æ –ú–û–ñ–ù–û –í–ò–î–ï–¢–¨", a: "–í–ò–ö–¢–û–† –ì–Æ–ì–û"},
        {q: "–ü–£–°–¢–¨ –¢–í–û–ï –°–ï–†–î–¶–ï –ë–£–î–ï–¢ –¢–ï–ü–õ–´–ú –ö–û–ì–î–ê –í–û–ö–†–£–ì –•–û–õ–û–î–ù–û", a: "–Ø–ü–û–ù–°–ö–ê–Ø –ú–£–î–†–û–°–¢–¨"},
        {q: "–ó–ò–ú–ê –ü–†–ò–ö–†–´–í–ê–ï–¢ –ó–ï–ú–õ–Æ –û–î–ï–Ø–õ–û–ú –ò–ó –ß–ò–°–¢–û–ì–û –°–ï–†–ï–ë–†–ê", a: "–§–ï–î–û–† –¢–Æ–¢–ß–ï–í"},
        {q: "–£ –ó–ò–ú–´ –ù–ï–¢ –ì–û–õ–û–°–ê –ù–û –û–ù–ê –£–ú–ï–ï–¢ –ü–ï–¢–¨ –í–ï–¢–†–û–ú", a: "–ê–õ–ï–ö–°–ê–ù–î–† –ü–£–®–ö–ò–ù"},
        {q: "–ú–´ –í–°–ï –ö–ê–ö –°–ù–ï–ñ–ò–ù–ö–ò –ö–†–ê–°–ò–í–´ –ò –°–û–í–ï–†–®–ï–ù–ù–û –†–ê–ó–ù–´–ï", a: "–ú–´–°–õ–¨ –î–ù–Ø"},
        {q: "–ó–ò–ú–û–ô –õ–ï–ì–ß–ï –í–ï–†–ò–¢–°–Ø –í –°–ö–ê–ó–ö–£", a: "–û–°–ö–ê–† –£–ê–ô–õ–¨–î"},
        {q: "–õ–ï–° –ú–û–õ–ß–ò–¢ –ù–û –í –≠–¢–û–ú –ú–û–õ–ß–ê–ù–ò–ò –ú–ù–û–ì–û –°–ú–´–°–õ–ê", a: "–ò–í–ê–ù –ë–£–ù–ò–ù"},
        {q: "–•–û–õ–û–î –ù–£–ñ–ï–ù –ß–¢–û–ë–´ –ú–´ –ö–†–ï–ü–ß–ï –î–ï–†–ñ–ê–õ–ò–°–¨ –ó–ê –†–£–ö–ò", a: "–§–†–ê–ù–¶–£–ó–°–ö–ê–Ø –¶–ò–¢–ê–¢–ê"},
        {q: "–ó–ò–ú–ê –≠–¢–û –ß–ï–°–¢–ù–û–ï –í–†–ï–ú–Ø –ì–û–î–ê", a: "–ò–û–°–ò–§ –ë–†–û–î–°–ö–ò–ô"},
        {q: "–õ–ï–î –ú–û–ñ–ï–¢ –†–ê–°–¢–ê–Ø–¢–¨ –û–¢ –û–î–ù–û–ì–û –î–û–ë–†–û–ì–û –°–õ–û–í–ê", a: "–ü–û–ì–û–í–û–†–ö–ê"},
        {q: "–í–ï–°–ù–ê –ó–ê–†–û–ñ–î–ê–ï–¢–°–Ø –í –ì–õ–£–ë–ò–ù–ï –°–ê–ú–û–ô –°–£–†–û–í–û–ô –ó–ò–ú–´", a: "–ê–õ–¨–ë–ï–† –ö–ê–ú–Æ"},
        {q: "–ú–ê–õ–ï–ù–¨–ö–û–ï –î–û–ë–†–û–ï –î–ï–õ–û –ì–†–ï–ï–¢ –õ–£–ß–®–ï –õ–Æ–ë–û–ô –ü–ï–ß–ö–ò", a: "–ù–ê–†–û–î–ù–ê–Ø –ú–£–î–†–û–°–¢–¨"},
        {q: "–°–ù–ï–ñ–ò–ù–ö–ê –ú–û–ñ–ï–¢ –í–´–ó–í–ê–¢–¨ –õ–ê–í–ò–ù–£", a: "–°–¢–ê–ù–ò–°–õ–ê–í –õ–ï–ú"},
        {q: "–ó–ò–ú–ê –û–ß–ò–©–ê–ï–¢ –ú–ò–† –û–¢ –í–°–ï–ì–û –õ–ò–®–ù–ï–ì–û", a: "–õ–ï–í –¢–û–õ–°–¢–û–ô"},
        {q: "–í–ï–¢–ï–† –ó–ò–ú–û–ô –ü–û–ï–¢ –ü–ï–°–ù–Æ –û –¢–ï–ü–õ–û–ú –î–û–ú–ï", a: "–°–ï–†–ì–ï–ô –ï–°–ï–ù–ò–ù"},
        {q: "–ú–û–†–û–ó –†–ò–°–£–ï–¢ –¶–í–ï–¢–´ –¢–ê–ú –ì–î–ï –ù–ï–¢ –ñ–ò–ó–ù–ò", a: "–ì–ê–ù–° –ê–ù–î–ï–†–°–ï–ù"},
        {q: "–ó–ò–ú–ê –≠–¢–û –°–û–ù –ü–†–ò–†–û–î–´ –ü–ï–†–ï–î –ü–†–û–ë–£–ñ–î–ï–ù–ò–ï–ú", a: "–ê–†–ò–°–¢–û–¢–ï–õ–¨"}
    ];

    const layouts = {
        ru: ["–ô–¶–£–ö–ï–ù–ì–®–©–ó–•–™", "–§–´–í–ê–ü–†–û–õ–î–ñ–≠", "–Ø–ß–°–ú–ò–¢–¨–ë–Æ"],
        en: ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"]
    };

    let sdk, p_obj, p_data = [], c_map = {}, selIdx = 0, score = 0, best = 0, lives = 3, lang = 'ru';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SDK
    if (typeof YaGames !== 'undefined') {
        YaGames.init().then(y => {
            sdk = y;
            lang = sdk.environment.i18n.lang.startsWith('ru') ? 'ru' : 'en';
            best = localStorage.getItem('cry_best_z') || 0;
            document.getElementById('ui-record').innerText = best;
            if (sdk.features?.LoadingAPI) sdk.features.LoadingAPI.ready();
        });
    }

    function start() {
        document.getElementById('sc-menu').style.display = 'none';
        document.getElementById('h-ui').style.display = 'flex';
        document.getElementById('m-ui').style.display = 'flex';
        document.getElementById('f-ui').style.display = 'block';
        initLvl();
    }

    function initLvl() {
        lives = 3;
        p_obj = phrases[Math.floor(Math.random() * phrases.length)];
        p_data = []; c_map = {}; 
        
        const full = (p_obj.q + p_obj.a).replace(/\s/g, '');
        const uni = [...new Set(full.split(''))];
        const nums = Array.from({length: 80}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        uni.forEach((l, i) => c_map[l] = nums[i]);

        [...p_obj.q].forEach(c => addC(c));
        p_data.push({ isDiv: true });
        [...p_obj.a].forEach(c => addC(c));

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–¥–Ω—É —Å–ª—É—á–∞–π–Ω—É—é –±—É–∫–≤—É –≤ –Ω–∞—á–∞–ª–µ
        const auto = uni[Math.floor(Math.random() * uni.length)];
        p_data.forEach(p => { if(p.corr === auto) p.usr = p.corr; });

        moveFirst();
        updUI();
    }

    function addC(c) {
        if (c === ' ') p_data.push({ isSp: true });
        else p_data.push({ corr: c, num: c_map[c], usr: '' });
    }

    function updUI() {
        const cont = document.getElementById('puzzle-container'); 
        cont.innerHTML = '';
        let row = docR();

        p_data.forEach((p, i) => {
            if (p.isDiv) {
                cont.appendChild(row); 
                const d = document.createElement('div'); d.className = 'author-div';
                cont.appendChild(d); row = d; return;
            }
            if (p.isSp) { 
                cont.appendChild(row); row = docR(); return; 
            }
            
            const cell = document.createElement('div');
            cell.className = `cell ${i === selIdx ? 'sel' : ''} ${p.usr ? 'ok' : ''}`;
            cell.innerHTML = `<div class="box">${p.usr || ''}</div><div class="num">${p.num}</div>`;
            cell.onclick = () => { selIdx = i; updUI(); };
            row.appendChild(cell);
        });
        cont.appendChild(row);

        const kArea = document.getElementById('kbd'); kArea.innerHTML = '';
        layouts[lang].forEach(rStr => {
            const div = document.createElement('div'); div.className = 'kbd-row';
            rStr.split('').forEach(l => {
                const k = document.createElement('div'); k.className = 'key';
                if (isFinished(l)) k.classList.add('faded');
                k.innerText = l; k.onclick = () => tapKey(l);
                div.appendChild(k);
            });
            kArea.appendChild(div);
        });

        document.getElementById('l-val').innerText = "‚ù§Ô∏è".repeat(lives);
        document.getElementById('s-val').innerText = score;
        checkWin();
    }

    function isFinished(l) {
        const charData = p_data.filter(p => p.corr === l);
        return charData.length > 0 && charData.every(p => p.usr === l);
    }

    function tapKey(l) {
        const data = p_data[selIdx];
        if(!data || data.usr || data.isSp || data.isDiv) return;

        if (l === data.corr) {
            const charToOpen = data.corr;
            p_data.forEach(p => { if(p.corr === charToOpen) p.usr = charToOpen; });
            score += 10;
            moveNext();
        } else {
            lives--;
            const cell = document.querySelectorAll('.cell.sel')[0];
            if(cell) {
                cell.classList.add('bad');
                setTimeout(() => cell.classList.remove('bad'), 300);
            }
            if (lives <= 0) {
                if (sdk) sdk.adv.showFullscreenAdv({ callbacks: { onClose: () => { document.getElementById('sc-fail').style.display = 'flex'; } } });
                else document.getElementById('sc-fail').style.display = 'flex';
            }
        }
        updUI();
    }

    function moveNext() {
        for(let i = selIdx; i < p_data.length; i++) {
            if(!p_data[i].isSp && !p_data[i].isDiv && !p_data[i].usr) { selIdx = i; return; }
        }
        for(let i = 0; i < selIdx; i++) {
            if(!p_data[i].isSp && !p_data[i].isDiv && !p_data[i].usr) { selIdx = i; return; }
        }
    }

    function moveFirst() {
        for(let i=0; i<p_data.length; i++) {
            if(!p_data[i].isSp && !p_data[i].isDiv && !p_data[i].usr) { selIdx = i; break; }
        }
    }

    function checkWin() {
        const isWin = p_data.every(p => p.isSp || p.isDiv || p.usr !== '');
        if(isWin && p_data.length > 0) {
            if(score > best) {
                best = score;
                localStorage.setItem('cry_best_z', best);
                document.getElementById('ui-record').innerText = best;
            }
            document.getElementById('ui-auth-name').innerText = "‚Äî " + p_obj.a;
            document.getElementById('sc-win').style.display = 'flex';
        }
    }

    function showHint() {
        if (!sdk) { executeHint(); return; }
        sdk.adv.showRewardedVideo({
            callbacks: {
                onOpen: () => {},
                onRewarded: () => { executeHint(); },
                onClose: () => {},
                onError: (e) => { console.log('Error:', e); }
            }
        });
    }

    function executeHint() {
        const p = p_data[selIdx];
        if (p && !p.usr) {
            const char = p.corr;
            p_data.forEach(item => { if(item.corr === char) item.usr = char; });
            score += 5;
            moveNext();
            updUI();
        }
    }

    function nextLvl() {
        document.getElementById('sc-win').style.display = 'none';
        if (sdk) {
            sdk.adv.showFullscreenAdv({
                callbacks: { onClose: () => initLvl() }
            });
        } else {
            initLvl();
        }
    }

    function docR() { const d = document.createElement('div'); d.className = 'word'; return d; }

    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ü–ö
    window.addEventListener('keydown', (e) => {
        const k = e.key.toUpperCase();
        const allKeys = layouts.ru.join('') + layouts.en.join('');
        if(allKeys.includes(k)) tapKey(k);
    });

    // –°–Ω–µ–∂–∏–Ω–∫–∏
    setInterval(() => {
        if(document.hidden) return;
        const sf = document.createElement('div');
        sf.className = 'snowflake';
        sf.innerText = '‚ùÑ';
        sf.style.left = Math.random() * 100 + 'vw';
        sf.style.fontSize = (Math.random() * 10 + 10) + 'px';
        sf.style.animation = `fall ${Math.random() * 4 + 4}s linear forwards`;
        document.getElementById('snow-container').appendChild(sf);
        setTimeout(() => sf.remove(), 8000);
    }, 600);
</script>
</body>
</html>
