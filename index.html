<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞–º–º–∞: –ó–∏–º–Ω–∏–µ –¢–∞–π–Ω—ã</title>
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <style>
        :root {
            --bg-color: #d6e4f0;
            --card: rgba(255, 255, 255, 0.98);
            --primary: #c0392b; 
            --correct: #27ae60;
            --error: #e74c3c;
            --text: #2c3e50;
            --border: #d1d5db;
            --hint: #2980b9;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            outline: none;
        }

        html, body {
            margin: 0; padding: 0; 
            width: 100%; height: 100%;
            overflow: hidden; 
            background-color: var(--bg-color);
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; 
            flex-direction: column;
            background-image: radial-gradient(circle at center, #e1eef6 0%, #d6e4f0 100%);
        }

        #snow-container { position: fixed; inset: 0; pointer-events: none; z-index: 100; overflow: hidden; }
        .snowflake { position: absolute; top: -10px; color: white; opacity: 0.8; pointer-events: none; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

        /* HEADER */
        header {
            background: #fff;
            display: flex; flex-direction: column;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100; flex-shrink: 0;
        }
        .header-top {
            height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
        }
        .stats { display: flex; gap: 12px; font-weight: 800; font-size: 0.85rem; align-items: center; }
        .lvl-tag { background: #34495e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .timer-val { font-family: monospace; font-size: 1rem; color: #34495e; min-width: 45px; }

        .progress-container { height: 6px; width: 100%; background: #eee; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background: var(--correct); transition: width 0.4s ease; }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        main { flex: 1; overflow-y: auto; display: flex; flex-direction: column; padding: 20px 10px; }
        #puzzle-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; width: 100%; max-width: 800px; margin: 0 auto; }

        .word { display: flex; gap: 4px; margin-right: 12px; margin-bottom: 20px; }
        .author-div { border-top: 2px dashed #bdc3c7; padding-top: 15px; margin-top: 5px; width: 100%; display: flex; justify-content: center; flex-wrap: wrap; }

        .cell { width: clamp(32px, 8vw, 42px); display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .box {
            width: 100%; aspect-ratio: 1/1.1; background: var(--card);
            border: 2px solid var(--border); border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: clamp(1rem, 5vw, 1.4rem); font-weight: 900; color: var(--text);
        }
        .num { margin-top: 3px; font-size: 0.6rem; color: #7f8c8d; font-weight: bold; }

        .cell.sel .box { border-color: var(--primary); transform: scale(1.1); z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .cell.ok .box { color: var(--correct); border-color: var(--correct); background: #fafffa; animation: pop 0.3s ease-out; }
        .cell.bad .box { animation: shake 0.3s ease-in-out; border-color: var(--error); }

        @keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-4px);} 75%{transform:translateX(4px);} }

        /* –ö–õ–ê–í–ò–ê–¢–£–†–ê */
        #footer { flex-shrink: 0; background: #f8f9fa; padding: 10px 5px calc(10px + env(safe-area-inset-bottom)); box-shadow: 0 -2px 15px rgba(0,0,0,0.1); }
        .kbd-row { display: flex; justify-content: center; gap: 3px; margin-bottom: 4px; }
        .key {
            background: #fff; height: clamp(40px, 6vh, 50px); flex: 1; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: clamp(0.9rem, 4vw, 1.1rem);
            cursor: pointer; border: 1px solid #ddd; box-shadow: 0 2px 0 #ccc; max-width: 45px;
        }
        .key.faded { opacity: 0.3; background: #eee; pointer-events: none; }

        /* –≠–ö–†–ê–ù–´ */
        .ovl {
            position: fixed; inset: 0; z-index: 500; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            background: rgba(44, 62, 80, 0.98); color: white; padding: 20px; text-align: center;
        }
        .btn { background: var(--correct); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 1.2rem; font-weight: 900; cursor: pointer; margin-top: 15px; width: 220px; }

        #sc-fail { background: var(--primary); }
        #sc-pause { background: rgba(52, 73, 94, 0.95); }

        #mute-btn, #pause-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 5px; }
        .final-time { font-size: 1.1rem; color: #f1c40f; margin-bottom: 10px; font-weight: 800; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="snow-container"></div>

<!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
<div id="sc-menu" class="ovl" style="display: flex; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
    <div style="font-size: 5rem;">‚ùÑÔ∏è</div>
    <h1 style="margin: 10px 0;">–ó–ò–ú–ù–ò–ï –¢–ê–ô–ù–´</h1>
    <div style="margin: 20px 0; padding: 10px 25px; background: rgba(255,255,255,0.1); border-radius: 15px;">
        <div style="font-size: 0.8rem; opacity: 0.7;">–õ–£–ß–®–ò–ô –°–ß–ï–¢</div>
        <div style="font-size: 2rem; font-weight: 900; color: #f1c40f;" id="ui-record">0</div>
    </div>
    <button class="btn" onclick="startNewGame()">–ò–ì–†–ê–¢–¨</button>
</div>

<!-- –ü–ê–£–ó–ê -->
<div id="sc-pause" class="ovl">
    <div style="font-size: 4rem;">‚è≥</div>
    <h2>–ü–ê–£–ó–ê</h2>
    <button class="btn" onclick="resumeGame()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
    <button class="btn" style="background: #7f8c8d;" onclick="goHome()">–í –ú–ï–ù–Æ</button>
</div>

<!-- –ü–†–û–ò–ì–†–´–® -->
<div id="sc-fail" class="ovl">
    <div style="font-size: 4rem;">ü•Ä</div>
    <h2>–ü–û–ü–´–¢–ö–ò –ó–ê–ö–û–ù–ß–ò–õ–ò–°–¨</h2>
    <p>–ù–µ —Å–¥–∞–≤–∞–π—Ç–µ—Å—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!</p>
    <button class="btn" style="background: #fff; color: var(--primary);" onclick="goHome()">–í –ú–ï–ù–Æ</button>
</div>

<!-- –ü–û–ë–ï–î–ê -->
<div id="sc-win" class="ovl">
    <div style="font-size: 4rem;">‚≠ê</div>
    <h2>–†–ê–ó–ì–ê–î–ê–ù–û!</h2>
    <div class="final-time">–í—Ä–µ–º—è: <span id="win-time">00:00</span></div>
    <div style="margin: 15px; font-size: 1.1rem; font-style: italic; line-height: 1.4;" id="win-quote"></div>
    <p id="ui-auth-name" style="color:#f1c40f; font-weight: 900; margin-top: 0;"></p>
    <button class="btn" onclick="nextLvl()">–î–ê–õ–ï–ï</button>
</div>

<!-- –ì–ï–ô–ú–ü–õ–ï–ô -->
<header id="h-ui" style="display:none;">
    <div class="header-top">
        <div class="stats">
            <button id="pause-btn" onclick="pauseGame()">‚è∏Ô∏è</button>
            <div class="timer-val" id="timer-display">00:00</div>
            <span>üèÜ <span id="s-val">0</span></span>
            <span style="color:var(--primary)">‚ù§Ô∏è <span id="l-val">3</span></span>
            <span class="lvl-tag">–£–† <span id="lvl-num">1</span></span>
        </div>
        <button id="mute-btn" onclick="toggleMute()">üîä</button>
    </div>
    <div class="progress-container"><div id="progress-fill"></div></div>
</header>

<main id="m-ui" style="display:none;"><div id="puzzle-container"></div></main>

<div id="f-ui" style="display:none;">
    <div id="kbd"></div>
    <button style="background: var(--hint); color: #fff; border: none; padding: 12px; border-radius: 10px; font-weight: 800; width: 95%; max-width: 400px; display: block; margin: 8px auto 0; cursor: pointer; font-size: 0.8rem;" onclick="showHint()">–û–¢–ö–†–´–¢–¨ –ë–£–ö–í–£ (–†–ï–ö–õ–ê–ú–ê)</button>
</div>

<script>
    // --- –ó–í–£–ö–û–í–û–ô –î–í–ò–ñ–û–ö ---
    const AudioEngine = {
        ctx: null, muted: false,
        init() { if(!this.ctx) try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} },
        play(freq, type, duration, vol = 0.1) {
            if (!this.ctx || this.muted) return;
            if (this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        correct() { this.play(880, 'sine', 0.2); },
        wrong() { this.play(110, 'triangle', 0.3, 0.2); },
        win() { [523, 659, 783, 1046].forEach((f, i) => setTimeout(() => this.play(f, 'sine', 0.4, 0.1), i * 150)); }
    };

    const phrases = [
        {q: "–ó–ò–ú–ê –≠–¢–û –í–†–ï–ú–Ø –î–õ–Ø –ö–û–ú–§–û–†–¢–ê –•–û–†–û–®–ï–ô –ï–î–´ –ò –¢–ï–ü–õ–ê", a: "–≠–î–ò–¢ –°–ò–¢–£–≠–õ–õ"},
        {q: "–ö–ê–ñ–î–ê–Ø –°–ù–ï–ñ–ò–ù–ö–ê –≠–¢–û –í–ó–î–û–• –û–ë–õ–ï–ì–ß–ï–ù–ò–Ø –ü–†–ò–†–û–î–´", a: "–ù–ï–ò–ó–í–ï–°–¢–ù–´–ô"},
        {q: "–õ–Æ–ë–û–í–¨ –°–û–ì–†–ï–í–ê–ï–¢ –î–ê–ñ–ï –í –°–ê–ú–´–ô –õ–Æ–¢–´–ô –ú–û–†–û–ó", a: "–ü–û–°–õ–û–í–ò–¶–ê"},
        {q: "–ó–ò–ú–ê –ü–†–ò–•–û–î–ò–¢ –ß–¢–û–ë–´ –ú–´ –¶–ï–ù–ò–õ–ò –í–ï–°–ù–£", a: "–ê–ù–¢–û–ù –ß–ï–•–û–í"},
        {q: "–°–ù–ï–ì–û–ü–ê–î –≠–¢–û –ú–£–ó–´–ö–ê –ö–û–¢–û–†–£–Æ –ú–û–ñ–ù–û –í–ò–î–ï–¢–¨", a: "–í–ò–ö–¢–û–† –ì–Æ–ì–û"},
        {q: "–ó–ò–ú–ê –≠–¢–û –ß–ï–°–¢–ù–û–ï –í–†–ï–ú–Ø –ì–û–î–ê", a: "–ò–û–°–ò–§ –ë–†–û–î–°–ö–ò–ô"},
        {q: "–ú–û–†–û–ó –†–ò–°–£–ï–¢ –¶–í–ï–¢–´ –¢–ê–ú –ì–î–ï –ù–ï–¢ –ñ–ò–ó–ù–ò", a: "–ì–ê–ù–° –ê–ù–î–ï–†–°–ï–ù"},
        {q: "–ó–ò–ú–ê –≠–¢–û –°–û–ù –ü–†–ò–†–û–î–´ –ü–ï–†–ï–î –ü–†–û–ë–£–ñ–î–ï–ù–ò–ï–ú", a: "–ê–†–ò–°–¢–û–¢–ï–õ–¨"}
    ];

    let sdk, p_obj, p_data = [], selIdx = 0, score = 0, best = 0, lives = 3, level = 1, isPaused = false;
    let seconds = 0, timerInterval = null;

    if (typeof YaGames !== 'undefined') {
        YaGames.init().then(y => { sdk = y; best = localStorage.getItem('cry_best_z') || 0; document.getElementById('ui-record').innerText = best; });
    }

    // --- –¢–ê–ô–ú–ï–† ---
    function startTimer() {
        stopTimer();
        timerInterval = setInterval(() => {
            if (!isPaused) {
                seconds++;
                document.getElementById('timer-display').innerText = formatTime(seconds);
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–ï–ú ---
    function startNewGame() {
        AudioEngine.init();
        level = 1; score = 0;
        document.getElementById('sc-menu').style.display = 'none';
        document.getElementById('h-ui').style.display = 'flex';
        document.getElementById('m-ui').style.display = 'flex';
        document.getElementById('f-ui').style.display = 'block';
        initLvl();
    }

    function pauseGame() { 
        if(document.getElementById('sc-win').style.display === 'flex' || document.getElementById('sc-fail').style.display === 'flex') return;
        isPaused = true; 
        document.getElementById('sc-pause').style.display = 'flex'; 
    }

    function resumeGame() { 
        isPaused = false; 
        document.getElementById('sc-pause').style.display = 'none'; 
    }

    function goHome() {
        isPaused = false;
        stopTimer();
        document.getElementById('sc-pause').style.display = 'none';
        document.getElementById('sc-fail').style.display = 'none';
        document.getElementById('sc-win').style.display = 'none';
        document.getElementById('h-ui').style.display = 'none';
        document.getElementById('m-ui').style.display = 'none';
        document.getElementById('f-ui').style.display = 'none';
        document.getElementById('sc-menu').style.display = 'flex';
    }

    function initLvl() {
        lives = 3; isPaused = false; seconds = 0;
        document.getElementById('timer-display').innerText = "00:00";
        startTimer();

        p_obj = phrases[Math.floor(Math.random() * phrases.length)];
        p_data = [];
        let c_map = {}, uni = [...new Set((p_obj.q + p_obj.a).replace(/\s/g, '').split(''))];
        let nums = Array.from({length: 100}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        uni.forEach((l, i) => c_map[l] = nums[i]);

        const fill = (t) => [...t].forEach(c => c === ' ' ? p_data.push({isSp:1}) : p_data.push({corr:c, num:c_map[c], usr:''}));
        fill(p_obj.q); p_data.push({isDiv:1}); fill(p_obj.a);

        let sChar = uni[Math.floor(Math.random() * uni.length)];
        p_data.forEach(p => { if(p.corr === sChar) p.usr = sChar; });
        moveNext(); updUI();
    }

    function updUI() {
        const cont = document.getElementById('puzzle-container'); cont.innerHTML = '';
        let row = document.createElement('div'); row.className = 'word';
        let total = 0, solved = 0;

        p_data.forEach((p, i) => {
            if (p.isDiv) { cont.appendChild(row); let d = document.createElement('div'); d.className='author-div'; cont.appendChild(d); row=document.createElement('div'); row.className='word'; return; }
            if (p.isSp) { cont.appendChild(row); row=document.createElement('div'); row.className='word'; return; }
            total++; if(p.usr) solved++;
            const cell = document.createElement('div');
            cell.className = `cell ${i === selIdx ? 'sel' : ''} ${p.usr ? 'ok' : ''}`;
            cell.innerHTML = `<div class="box">${p.usr}</div><div class="num">${p.num}</div>`;
            cell.onclick = () => { if(!isPaused) { selIdx = i; updUI(); } };
            row.appendChild(cell);
        });
        cont.appendChild(row);

        document.getElementById('progress-fill').style.width = (solved/total*100) + '%';
        document.getElementById('s-val').innerText = score;
        document.getElementById('l-val').innerText = lives;
        document.getElementById('lvl-num').innerText = level;

        renderKbd();
        if (solved === total && total > 0) { AudioEngine.win(); win(); }
    }

    function renderKbd() {
        const kArea = document.getElementById('kbd'); kArea.innerHTML = '';
        ["–ô–¶–£–ö–ï–ù–ì–®–©–ó–•–™", "–§–´–í–ê–ü–†–û–õ–î–ñ–≠", "–Ø–ß–°–ú–ò–¢–¨–ë–Æ"].forEach(rStr => {
            const div = document.createElement('div'); div.className = 'kbd-row';
            rStr.split('').forEach(l => {
                const k = document.createElement('div'); k.className = 'key';
                const isDone = p_data.filter(p => p.corr === l).length > 0 && p_data.filter(p => p.corr === l).every(p => p.usr === l);
                if (isDone) k.classList.add('faded');
                k.innerText = l; k.onclick = () => { if(!isPaused) tapKey(l); };
                div.appendChild(k);
            });
            kArea.appendChild(div);
        });
    }

    function tapKey(l) {
        const p = p_data[selIdx];
        if (!p || p.usr) return;
        if (l === p.corr) {
            AudioEngine.correct();
            p_data.forEach(item => { if(item.corr === l) item.usr = l; });
            score += 10; moveNext();
        } else {
            AudioEngine.wrong();
            lives--;
            const cell = document.querySelector('.cell.sel');
            if(cell) { cell.classList.add('bad'); setTimeout(()=>cell.classList.remove('bad'), 300); }
            if (lives <= 0) { isPaused = true; stopTimer(); document.getElementById('sc-fail').style.display = 'flex'; }
        }
        updUI();
    }

    function moveNext() {
        for(let i = selIdx; i < p_data.length; i++) if(!p_data[i].isSp && !p_data[i].isDiv && !p_data[i].usr) { selIdx = i; return; }
        for(let i = 0; i < selIdx; i++) if(!p_data[i].isSp && !p_data[i].isDiv && !p_data[i].usr) { selIdx = i; return; }
    }

    function win() {
        isPaused = true; stopTimer();
        document.getElementById('win-time').innerText = formatTime(seconds);
        document.getElementById('win-quote').innerText = `"${p_obj.q}"`;
        document.getElementById('ui-auth-name').innerText = "‚Äî " + p_obj.a;
        document.getElementById('sc-win').style.display = 'flex';
        if (score > best) { best = score; localStorage.setItem('cry_best_z', best); document.getElementById('ui-record').innerText = best; }
    }

    function nextLvl() {
        level++; score += 50;
        document.getElementById('sc-win').style.display = 'none';
        if (sdk) sdk.adv.showFullscreenAdv({ callbacks: { onClose: initLvl } }); else initLvl();
    }

    function showHint() {
        if(isPaused) return;
        if (!sdk) { executeHint(); return; }
        sdk.adv.showRewardedVideo({ callbacks: { onRewarded: executeHint } });
    }

    function executeHint() {
        const p = p_data[selIdx];
        if (p) {
            AudioEngine.correct();
            const char = p.corr;
            p_data.forEach(item => { if(item.corr === char) item.usr = char; });
            moveNext(); updUI();
        }
    }

    function toggleMute() {
        AudioEngine.muted = !AudioEngine.muted;
        document.getElementById('mute-btn').innerText = AudioEngine.muted ? 'üîá' : 'üîä';
    }

    setInterval(() => {
        if(document.hidden) return;
        const sf = document.createElement('div');
        sf.className = 'snowflake'; sf.innerText = '‚ùÑ';
        sf.style.left = Math.random() * 100 + 'vw';
        sf.style.animation = `fall ${Math.random() * 3 + 3}s linear forwards`;
        document.getElementById('snow-container').appendChild(sf);
        setTimeout(() => sf.remove(), 5000);
    }, 500);
</script>
</body>
</html>
