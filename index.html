<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞–º–º–∞: –ó–∏–º–Ω–∏–µ –¢–∞–π–Ω—ã</title>
    <!-- SDK Yandex Games -->
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <style>
        :root {
            --bg-color: #d6e4f0;
            --card: rgba(255, 255, 255, 0.98);
            --primary: #c0392b; 
            --correct: #27ae60;
            --error: #e74c3c;
            --text: #2c3e50;
            --border: #d1d5db;
            --hint-color: #2980b9;
            --tv-focus: #f1c40f;
        }

        /* –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ö–ò (–ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –º–µ–Ω—é - –ø. 1.6.2.7) */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            outline: none;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            overflow: hidden; background-color: var(--bg-color);
            overscroll-behavior: none; /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ swipe-to-refresh iOS */
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; flex-direction: column;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cpath d='M30 5 L38 22 L32 22 L45 38 L35 38 L35 50 L25 50 L25 38 L15 38 L28 22 L22 22 Z' fill='%2327ae60' fill-opacity='0.08'/%3E%3C/svg%3E");
            background-attachment: fixed;
        }

        #snow-container { position: fixed; inset: 0; pointer-events: none; z-index: 100; overflow: hidden; }
        .snowflake { position: absolute; top: -20px; color: white; opacity: 0.6; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –®–ê–ü–ö–ò */
        header {
            height: 60px; background: #fff; display: flex; justify-content: space-between;
            align-items: center; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 11; flex-shrink: 0;
        }
        .stats { display: flex; gap: 20px; font-weight: 900; }
        .lives { color: var(--error); letter-spacing: 2px; }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï (–ê–î–ê–ü–¢–ò–í–ù–´–ô –°–ö–†–û–õ–õ - –ø. 1.10.1) */
        main {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; overflow-x: hidden; padding: 15px;
            scroll-behavior: smooth;
        }

        #puzzle-container {
            display: flex; flex-wrap: wrap; justify-content: center;
            align-content: flex-start; gap: 8px; width: 100%; margin-bottom: 40px;
        }

        .word { display: flex; gap: 5px; margin-right: 18px; margin-bottom: 25px; }
        .author-box { 
            border-top: 2px dashed #95a5a6; padding-top: 25px; margin-top: 10px; 
            width: 100%; display: flex; justify-content: center; flex-wrap: wrap; 
        }

        .cell { 
            width: clamp(35px, 8.5vw, 55px); display: flex; flex-direction: column; 
            align-items: center; cursor: pointer; transition: transform 0.15s;
        }
        .letter-box {
            width: 100%; aspect-ratio: 1/1.15; background: var(--card);
            border: 2px solid var(--border); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: clamp(1.2rem, 5vw, 1.8rem); font-weight: 900; box-shadow: 0 4px 0 #bdc3c7;
        }
        .num-label { margin-top: 5px; font-size: 0.75rem; color: #555; font-weight: 900; }

        /* –ü–û–î–°–í–ï–¢–ö–ê –ò –¢–í –§–û–ö–£–° */
        .cell.selected .letter-box { border-color: var(--primary); background: #fff; transform: translateY(-4px); box-shadow: 0 6px 12px rgba(192,57,43,0.3); }
        .cell.correct-cell .letter-box { color: var(--correct); border-color: var(--correct); box-shadow: 0 4px 0 rgba(46,204,113,0.2); }
        .cell.error-cell .letter-box { color: var(--error); border-color: var(--error); animation: shake 0.3s; }
        .tv-focused { border: 4px solid var(--tv-focus) !important; transform: scale(1.1); }

        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }

        /* –ö–õ–ê–í–ò–ê–¢–£–†–ê */
        #footer-ui {
            flex-shrink: 0; background: rgba(255, 255, 255, 0.95);
            padding: 10px 10px env(safe-area-inset-bottom);
            border-top: 1px solid #ddd; width: 100%; max-width: 800px; margin: 0 auto;
            border-radius: 20px 20px 0 0; z-index: 11;
        }
        .kbd-row { display: flex; justify-content: center; gap: 4px; margin-bottom: 6px; }
        .key {
            background: #fff; height: clamp(45px, 8vh, 60px); flex: 1; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: clamp(0.9rem, 4vw, 1.3rem);
            cursor: pointer; border: 1px solid #ddd; box-shadow: 0 3px 0 #ccc;
        }
        .key:active { transform: translateY(2px); box-shadow: none; }
        .key.finished { opacity: 0.2; background: #eee; pointer-events: none; }

        .hint-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .hint-btn { 
            background: var(--hint-color); color: #fff; border: none; padding: 14px; 
            border-radius: 12px; font-weight: bold; cursor: pointer; text-align: center; font-size: 0.7rem;
        }

        /* –≠–ö–†–ê–ù–´ */
        .overlay {
            position: fixed; inset: 0; z-index: 200; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; padding: 40px; text-align: center;
        }
        .btn-main { 
            background: var(--correct); color: white; border: none; padding: 22px 60px; 
            border-radius: 50px; font-size: 1.6rem; font-weight: 900; cursor: pointer; 
            margin-top: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* –¢–í –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø */
        body.is-tv .cell, body.is-tv .key, body.is-tv .hint-btn { outline: none; }

        /* –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú (–î–µ—Å–∫—Ç–æ–ø/–ü–ª–∞–Ω—à–µ—Ç) */
        @media (orientation: landscape) and (min-height: 500px) {
            body { flex-direction: row; }
            header { position: absolute; width: 100%; top: 0; left: 0; }
            main { padding-top: 80px; }
            #footer-ui { width: 320px; border-radius: 20px; margin: auto 15px; border: none; height: fit-content; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="snow-container"></div>

<!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
<div id="screen-menu" class="overlay" style="display: flex;">
    <div style="font-size: 6rem; margin-bottom: 20px;">üéÑ</div>
    <h1 style="font-size: 2.2rem; margin: 0;">–ö–†–ò–ü–¢–û–ì–†–ê–ú–ú–ê:<br>–ó–ò–ú–ù–ò–ï –¢–ê–ô–ù–´</h1>
    <div style="margin: 20px 0; font-size: 1.2rem; color: #f1c40f; font-weight: 900;">–†–ï–ö–û–†–î: <span id="ui-record">0</span></div>
    <button class="btn-main" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
</div>

<!-- –ü–û–ë–ï–î–ê -->
<div id="screen-win" class="overlay">
    <div style="font-size: 5rem;">üéÅ</div>
    <h2 id="win-quote-author" style="color: #f1c40f; margin-bottom: 10px;"></h2>
    <p id="win-phrase" style="font-style: italic; opacity: 0.9; margin-bottom: 30px; max-width: 500px;"></p>
    <button class="btn-main" onclick="nextLevel()">–î–ê–õ–¨–®–ï</button>
</div>

<!-- –ü–†–û–ò–ì–†–´–® -->
<div id="screen-fail" class="overlay" style="background: var(--primary);">
    <h2 style="font-size: 4rem;">–£–ü–°!</h2>
    <p>–ñ–∏–∑–Ω–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –¶–∏—Ç–∞—Ç–∞ –∑–∞—Å—Ç—ã–ª–∞ –≤–æ –ª—å–¥—É...</p>
    <button class="btn-main" style="background: #fff; color: var(--primary);" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
</div>

<!-- –ì–ï–ô–ú–ü–õ–ï–ô -->
<header id="game-header" style="display: none;">
    <div class="stats">
        <span>‚≠ê <span id="ui-score">0</span></span>
        <span class="lives" id="ui-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
    </div>
    <button onclick="location.reload()" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">üè†</button>
</header>

<main id="game-main" style="display: none;">
    <div id="puzzle-container"></div>
</main>

<div id="footer-ui" style="display: none;">
    <div id="keyboard-area"></div>
    <div class="hint-bar">
        <button class="hint-btn" onclick="useHint()">–û–¢–ö–†–´–¢–¨ –Ø–ß–ï–ô–ö–£<br><b>(–†–ï–ö–õ–ê–ú–ê)</b></button>
        <button class="hint-btn" style="background:#7f8c8d" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>
</div>

<script>
    /** –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ë–ò–ë–õ–ò–û–¢–ï–ö–ê **/
    const lib = [
        {q: "–í–û–û–ë–†–ê–ñ–ï–ù–ò–ï –í–ê–ñ–ù–ï–ï –ó–ù–ê–ù–ò–ô", a: "–ê–õ–¨–ë–ï–†–¢ –≠–ô–ù–®–¢–ï–ô–ù"},
        {q: "–ñ–ò–ó–ù–¨ –≠–¢–û –¢–û –ß–¢–û –°–õ–£–ß–ê–ï–¢–°–Ø –ü–û–ö–ê –í–´ –°–¢–†–û–ò–¢–ï –ü–õ–ê–ù–´", a: "–î–ñ–û–ù –õ–ï–ù–ù–û–ù"},
        {q: "–Ø –î–£–ú–ê–Æ –°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û –Ø –°–£–©–ï–°–¢–í–£–Æ", a: "–†–ï–ù–ï –î–ï–ö–ê–†–¢"},
        {q: "–í –°–û–í–ï–†–®–ï–ù–°–¢–í–ï –ù–ï–¢ –ù–ò–ß–ï–ì–û –ú–ê–õ–ï–ù–¨–ö–û–ì–û", a: "–ú–ò–ö–ï–õ–ê–ù–î–ñ–ï–õ–û"},
        {q: "–ü–û–ë–ï–ñ–î–ê–ï–¢ –¢–û–¢ –ö–¢–û –£–ú–ï–ï–¢ –ñ–î–ê–¢–¨", a: "–ö–£–¢–£–ó–û–í"},
        {q: "–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –°–ü–û–°–û–ë –î–ï–õ–ê–¢–¨ –í–ï–õ–ò–ö–ò–ï –í–ï–©–ò –≠–¢–û –õ–Æ–ë–ò–¢–¨ –°–í–û–ï –î–ï–õ–û", a: "–°–¢–ò–í –î–ñ–û–ë–°"}
    ];
    const layouts = {
        ru: ["–ô–¶–£–ö–ï–ù–ì–®–©–ó–•–™", "–§–´–í–ê–ü–†–û–õ–î–ñ–≠", "–Ø–ß–°–ú–ò–¢–¨–ë–Æ–Å"],
        en: ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"]
    };

    let sdk, puzzleData = [], charMap = {}, numMap = {}, phraseObj;
    let selectedIdx = 0, score = 0, record = 0, lives = 3, lang = 'ru';

    /** –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SDK **/
    if (typeof YaGames !== 'undefined') {
        YaGames.init().then(ysdk => {
            sdk = ysdk;
            lang = sdk.environment.i18n.lang.startsWith('ru') ? 'ru' : 'en';
            if (sdk.deviceInfo.type === 'tv') document.body.classList.add('is-tv');
            record = localStorage.getItem('cry_top_2026') || 0;
            document.getElementById('ui-record').innerText = record;
            if (sdk.features?.LoadingAPI) sdk.features.LoadingAPI.ready();
        });
    }

    /** –õ–û–ì–ò–ö–ê –ò–ì–†–´ **/
    function startGame() {
        document.getElementById('screen-menu').style.display = 'none';
        document.getElementById('game-header').style.display = 'flex';
        document.getElementById('game-main').style.display = 'flex';
        document.getElementById('footer-ui').style.display = 'block';
        initLevel();
    }

    function initLevel() {
        lives = 3; score = 0;
        const currentLib = lib; // –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —è–∑—ã–∫–∏
        phraseObj = currentLib[Math.floor(Math.random() * currentLib.length)];
        
        charMap = {}; numMap = {}; puzzleData = [];
        const full = (phraseObj.q + phraseObj.a).replace(/\s/g, '');
        const unique = [...new Set(full.split(''))];
        const nums = Array.from({length: 60}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        unique.forEach((l, i) => { charMap[l] = nums[i]; numMap[nums[i]] = l; });

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ
        [...phraseObj.q].forEach(c => addC(c));
        puzzleData.push({ isDiv: true });
        [...phraseObj.a].forEach(c => addC(c));

        // –ê–≤—Ç–æ–æ—Ç–∫—Ä—ã—Ç–∏–µ 2 —Å–ª—É—á–∞–π–Ω—ã—Ö –±—É–∫–≤ (—Ç—Ä–∞–¥–∏—Ü–∏—è –∂–∞–Ω—Ä–∞)
        const auto = unique.sort(() => Math.random() - 0.5).slice(0, 2);
        puzzleData.forEach(p => { if(!p.isSpace && !p.isDiv && auto.includes(p.correct)) p.user = p.correct; });

        autoSelectNext(0);
        updateUI();
    }

    function addC(c) {
        if (c === ' ') puzzleData.push({ isSpace: true });
        else puzzleData.push({ correct: c, num: charMap[c], user: '' });
    }

    function updateUI() {
        renderBoard();
        renderKeyboard();
        document.getElementById('ui-score').innerText = score;
        document.getElementById('ui-lives').innerText = "‚ù§Ô∏è".repeat(lives);
        if(score > record) { record = score; localStorage.setItem('cry_top_2026', record); }
        checkWin();
    }

    function renderBoard() {
        const cont = document.getElementById('puzzle-container');
        cont.innerHTML = '';
        let row = createRow();

        puzzleData.forEach((p, i) => {
            if (p.isDiv) {
                cont.appendChild(row);
                const d = document.createElement('div'); d.className = 'author-box';
                cont.appendChild(d); row = d; return;
            }
            if (p.isSpace) { cont.appendChild(row); row = createRow(); return; }

            const cell = document.createElement('div');
            cell.className = `cell ${i === selectedIdx ? 'selected' : ''}`;
            if (p.user === p.correct) cell.classList.add('correct-cell');
            cell.innerHTML = `<div class="letter-box">${p.user}</div><div class="num-label">${p.num}</div>`;
            cell.onclick = () => { selectedIdx = i; updateUI(); };
            row.appendChild(cell);
        });
        cont.appendChild(row);

        const sel = cont.querySelector('.selected');
        if (sel) sel.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function renderKeyboard() {
        const cont = document.getElementById('keyboard-area'); cont.innerHTML = '';
        layouts[lang].forEach(rowStr => {
            const div = document.createElement('div'); div.className = 'kbd-row';
            rowStr.split('').forEach(l => {
                const k = document.createElement('div');
                k.className = 'key';
                if (isLetterFinished(l)) k.classList.add('finished');
                k.innerText = l;
                k.onclick = () => handleInput(l);
                div.appendChild(k);
            });
            cont.appendChild(div);
        });
    }

    function createRow() { const d = document.createElement('div'); d.className = 'word'; return d; }

    function handleInput(l) {
        if (lives <= 0) return;
        const data = puzzleData[selectedIdx];
        if (!data || data.isDiv || data.isSpace) return;

        if (l === data.correct) {
            data.user = l; score += 10;
            autoSelectNext(selectedIdx + 1);
        } else {
            lives--;
            const cells = document.querySelectorAll('.cell');
            // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π –∏–Ω–¥–µ–∫—Å —è—á–µ–π–∫–∏ –≤ DOM (–º–∏–Ω—É—è –ø—Ä–æ–±–µ–ª—ã/–¥–∏–≤–∞–π–¥–µ—Ä—ã)
            let vIdx = 0;
            for(let i=0; i<selectedIdx; i++) if(!puzzleData[i].isSpace && !puzzleData[i].isDiv) vIdx++;
            if (cells[vIdx]) {
                cells[vIdx].classList.add('error-cell');
                setTimeout(updateUI, 300);
            }
            if (lives === 0) document.getElementById('screen-fail').style.display = 'flex';
        }
        updateUI();
    }

    function autoSelectNext(start) {
        for (let i = start; i < puzzleData.length; i++) {
            if (!puzzleData[i].isSpace && !puzzleData[i].isDiv && !puzzleData[i].user) {
                selectedIdx = i; return;
            }
        }
    }

    function isLetterFinished(l) {
        const matches = puzzleData.filter(p => p.correct === l);
        return matches.length > 0 && matches.every(p => p.user === l);
    }

    /** –†–ï–ö–õ–ê–ú–ê –ò –ü–û–î–°–ö–ê–ó–ö–ò (–ø. 4.5.1) **/
    function useHint() {
        if (!sdk) { execHint(); return; }
        sdk.adv.showRewardedVideo({ callbacks: { onRewarded: execHint } });
    }

    function execHint() {
        const p = puzzleData[selectedIdx];
        if (p && !p.isSpace && !p.isDiv) {
            p.user = p.correct;
            score += 5;
            autoSelectNext(selectedIdx + 1);
            updateUI();
        }
    }

    function checkWin() {
        if (puzzleData.length > 0 && puzzleData.every(p => p.isSpace || p.isDiv || p.user === p.correct)) {
            document.getElementById('win-quote-author').innerText = "‚Äî " + phraseObj.a;
            document.getElementById('win-phrase').innerText = phraseObj.q;
            document.getElementById('screen-win').style.display = 'flex';
        }
    }

    function nextLevel() {
        document.getElementById('screen-win').style.display = 'none';
        if (sdk) sdk.adv.showFullscreenAdv({ callbacks: { onClose: initLevel } });
        else initLevel();
    }

    /** –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–õ–ê–í–ò–ê–¢–£–†–´ (–ø. 1.6.2.4) **/
    window.addEventListener('keydown', (e) => {
        const k = e.key.toUpperCase();
        if (layouts[lang].join('').includes(k)) handleInput(k);
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¢–í-–ø—É–ª—å—Ç–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
        if (e.key === 'Backspace') location.reload();
    });

    /** –°–ù–ï–ñ–ò–ù–ö–ò (–≠–ö–û–ù–û–ú–ù–´–ï) **/
    const snowCont = document.getElementById('snow-container');
    for (let i = 0; i < 20; i++) {
        const sf = document.createElement('div');
        sf.className = 'snowflake'; sf.innerText = '‚ùÑ';
        sf.style.left = Math.random() * 100 + 'vw';
        sf.style.animationDuration = (Math.random() * 5 + 5) + 's';
        sf.style.animationDelay = (Math.random() * 5) + 's';
        snowCont.appendChild(sf);
    }
</script>
</body>
</html>
